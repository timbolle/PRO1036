<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tim Bollé">
<meta name="dcterms.date" content="2024-11-25">

<title>09 - Machine Learning – PRO1036</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">PRO1036</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../website/cours/cours.html"> 
<span class="menu-text">Cours</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../website/labs/labs.html"> 
<span class="menu-text">Labs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../website/exercices/exos.html"> 
<span class="menu-text">Exercices</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../website/projet/projet.html"> 
<span class="menu-text">Projet</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#modélisation" id="toc-modélisation" class="nav-link active" data-scroll-target="#modélisation">Modélisation</a>
  <ul class="collapse">
  <li><a href="#buts-de-lanalyse-de-données" id="toc-buts-de-lanalyse-de-données" class="nav-link" data-scroll-target="#buts-de-lanalyse-de-données">Buts de l’analyse de données</a></li>
  <li><a href="#modélisation-1" id="toc-modélisation-1" class="nav-link" data-scroll-target="#modélisation-1">Modélisation</a></li>
  <li><a href="#types-de-modèles" id="toc-types-de-modèles" class="nav-link" data-scroll-target="#types-de-modèles">Types de modèles</a></li>
  <li><a href="#types-de-modèles-1" id="toc-types-de-modèles-1" class="nav-link" data-scroll-target="#types-de-modèles-1">Types de modèles</a></li>
  <li><a href="#types-de-machine-learning" id="toc-types-de-machine-learning" class="nav-link" data-scroll-target="#types-de-machine-learning">Types de machine learning</a></li>
  <li><a href="#processus-de-modélisation" id="toc-processus-de-modélisation" class="nav-link" data-scroll-target="#processus-de-modélisation">Processus de modélisation</a></li>
  <li><a href="#processus-de-modélisation-1" id="toc-processus-de-modélisation-1" class="nav-link" data-scroll-target="#processus-de-modélisation-1">Processus de modélisation</a></li>
  <li><a href="#modeling-et-tidyverse" id="toc-modeling-et-tidyverse" class="nav-link" data-scroll-target="#modeling-et-tidyverse">Modeling et tidyverse</a></li>
  </ul></li>
  <li><a href="#modélisation---étapes-générales" id="toc-modélisation---étapes-générales" class="nav-link" data-scroll-target="#modélisation---étapes-générales">Modélisation - Étapes générales</a>
  <ul class="collapse">
  <li><a href="#étapes-générales" id="toc-étapes-générales" class="nav-link" data-scroll-target="#étapes-générales">Étapes générales</a></li>
  <li><a href="#les-données" id="toc-les-données" class="nav-link" data-scroll-target="#les-données">Les données</a></li>
  </ul></li>
  <li><a href="#séparation-des-données" id="toc-séparation-des-données" class="nav-link" data-scroll-target="#séparation-des-données">Séparation des données</a>
  <ul class="collapse">
  <li><a href="#séparation-des-données-1" id="toc-séparation-des-données-1" class="nav-link" data-scroll-target="#séparation-des-données-1">Séparation des données</a></li>
  <li><a href="#séparation-des-données-2" id="toc-séparation-des-données-2" class="nav-link" data-scroll-target="#séparation-des-données-2">Séparation des données</a></li>
  <li><a href="#séparation-des-données-3" id="toc-séparation-des-données-3" class="nav-link" data-scroll-target="#séparation-des-données-3">Séparation des données</a></li>
  <li><a href="#séparation-des-données-4" id="toc-séparation-des-données-4" class="nav-link" data-scroll-target="#séparation-des-données-4">Séparation des données</a></li>
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature engineering</a></li>
  </ul></li>
  <li><a href="#modélisation-2" id="toc-modélisation-2" class="nav-link" data-scroll-target="#modélisation-2">Modélisation</a>
  <ul class="collapse">
  <li><a href="#choix-du-modèle" id="toc-choix-du-modèle" class="nav-link" data-scroll-target="#choix-du-modèle">Choix du modèle</a></li>
  <li><a href="#entraînement-du-modèle" id="toc-entraînement-du-modèle" class="nav-link" data-scroll-target="#entraînement-du-modèle">Entraînement du modèle</a></li>
  <li><a href="#évaluation-du-modèle" id="toc-évaluation-du-modèle" class="nav-link" data-scroll-target="#évaluation-du-modèle">Évaluation du modèle</a></li>
  <li><a href="#prédiction-avec-le-modèle" id="toc-prédiction-avec-le-modèle" class="nav-link" data-scroll-target="#prédiction-avec-le-modèle">Prédiction avec le modèle</a></li>
  </ul></li>
  <li><a href="#rééchantillonnage" id="toc-rééchantillonnage" class="nav-link" data-scroll-target="#rééchantillonnage">Rééchantillonnage</a>
  <ul class="collapse">
  <li><a href="#rééchantillonnage-1" id="toc-rééchantillonnage-1" class="nav-link" data-scroll-target="#rééchantillonnage-1">Rééchantillonnage</a></li>
  <li><a href="#rééchantillonnage-2" id="toc-rééchantillonnage-2" class="nav-link" data-scroll-target="#rééchantillonnage-2">Rééchantillonnage</a></li>
  <li><a href="#validation-croisée" id="toc-validation-croisée" class="nav-link" data-scroll-target="#validation-croisée">Validation croisée</a></li>
  <li><a href="#rééchantillonnage-3" id="toc-rééchantillonnage-3" class="nav-link" data-scroll-target="#rééchantillonnage-3">Rééchantillonnage</a></li>
  </ul></li>
  <li><a href="#optimisation-des-hyperparamètres" id="toc-optimisation-des-hyperparamètres" class="nav-link" data-scroll-target="#optimisation-des-hyperparamètres">Optimisation des hyperparamètres</a>
  <ul class="collapse">
  <li><a href="#tune" id="toc-tune" class="nav-link" data-scroll-target="#tune"><code>tune()</code></a></li>
  <li><a href="#arbre-de-décisions" id="toc-arbre-de-décisions" class="nav-link" data-scroll-target="#arbre-de-décisions">Arbre de décisions</a></li>
  <li><a href="#arbre-de-décisions-1" id="toc-arbre-de-décisions-1" class="nav-link" data-scroll-target="#arbre-de-décisions-1">Arbre de décisions</a></li>
  <li><a href="#recherche-des-hyperparamètres" id="toc-recherche-des-hyperparamètres" class="nav-link" data-scroll-target="#recherche-des-hyperparamètres">Recherche des hyperparamètres</a></li>
  <li><a href="#recherche-des-hyperparamètres-1" id="toc-recherche-des-hyperparamètres-1" class="nav-link" data-scroll-target="#recherche-des-hyperparamètres-1">Recherche des hyperparamètres</a></li>
  <li><a href="#recherche-des-hyperparamètres-2" id="toc-recherche-des-hyperparamètres-2" class="nav-link" data-scroll-target="#recherche-des-hyperparamètres-2">Recherche des hyperparamètres</a></li>
  <li><a href="#analyse-des-résultats" id="toc-analyse-des-résultats" class="nav-link" data-scroll-target="#analyse-des-résultats">Analyse des résultats</a></li>
  <li><a href="#analyse-des-résultats-1" id="toc-analyse-des-résultats-1" class="nav-link" data-scroll-target="#analyse-des-résultats-1">Analyse des résultats</a></li>
  <li><a href="#choix-des-hyperparamètres" id="toc-choix-des-hyperparamètres" class="nav-link" data-scroll-target="#choix-des-hyperparamètres">Choix des hyperparamètres</a></li>
  <li><a href="#entraînement-du-modèle-1" id="toc-entraînement-du-modèle-1" class="nav-link" data-scroll-target="#entraînement-du-modèle-1">Entraînement du modèle</a></li>
  </ul></li>
  <li><a href="#recettes-et-workflows" id="toc-recettes-et-workflows" class="nav-link" data-scroll-target="#recettes-et-workflows">Recettes et workflows</a>
  <ul class="collapse">
  <li><a href="#feitures-engineering-avec-recipes" id="toc-feitures-engineering-avec-recipes" class="nav-link" data-scroll-target="#feitures-engineering-avec-recipes">Feitures engineering avec <code>recipes</code></a></li>
  <li><a href="#data-prerocessing" id="toc-data-prerocessing" class="nav-link" data-scroll-target="#data-prerocessing">Data prerocessing</a></li>
  <li><a href="#data-preprocessing" id="toc-data-preprocessing" class="nav-link" data-scroll-target="#data-preprocessing">Data preprocessing</a></li>
  <li><a href="#séparation-des-données-5" id="toc-séparation-des-données-5" class="nav-link" data-scroll-target="#séparation-des-données-5">Séparation des données</a></li>
  <li><a href="#recettes" id="toc-recettes" class="nav-link" data-scroll-target="#recettes">Recettes</a></li>
  <li><a href="#recettes-1" id="toc-recettes-1" class="nav-link" data-scroll-target="#recettes-1">Recettes</a></li>
  <li><a href="#recettes-2" id="toc-recettes-2" class="nav-link" data-scroll-target="#recettes-2">Recettes</a></li>
  <li><a href="#faire-un-workflow" id="toc-faire-un-workflow" class="nav-link" data-scroll-target="#faire-un-workflow">Faire un <code>workflow</code></a></li>
  <li><a href="#workflow" id="toc-workflow" class="nav-link" data-scroll-target="#workflow"><code>workflow</code></a></li>
  <li><a href="#entrainer-un-workflow" id="toc-entrainer-un-workflow" class="nav-link" data-scroll-target="#entrainer-un-workflow">Entrainer un <code>workflow</code></a></li>
  <li><a href="#rééchantillonnage-avec-un-workflow" id="toc-rééchantillonnage-avec-un-workflow" class="nav-link" data-scroll-target="#rééchantillonnage-avec-un-workflow">Rééchantillonnage avec un <code>workflow</code></a></li>
  <li><a href="#évaluation-du-modèle-1" id="toc-évaluation-du-modèle-1" class="nav-link" data-scroll-target="#évaluation-du-modèle-1">Évaluation du modèle</a></li>
  <li><a href="#hyperparamètres-et-workflow" id="toc-hyperparamètres-et-workflow" class="nav-link" data-scroll-target="#hyperparamètres-et-workflow">Hyperparamètres et <code>workflow</code></a></li>
  <li><a href="#hyperparamètres-et-workflow-1" id="toc-hyperparamètres-et-workflow-1" class="nav-link" data-scroll-target="#hyperparamètres-et-workflow-1">Hyperparamètres et <code>workflow</code></a></li>
  <li><a href="#références" id="toc-références" class="nav-link" data-scroll-target="#références">Références</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="09 - ML.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">09 - Machine Learning</h1>
<p class="subtitle lead">PRO1036 - Analyse de données scientifiques en R</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tim Bollé </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 25, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="modélisation" class="level1">
<h1>Modélisation</h1>
<section id="buts-de-lanalyse-de-données" class="level2">
<h2 class="anchored" data-anchor-id="buts-de-lanalyse-de-données">Buts de l’analyse de données</h2>
<ul>
<li>Comprendre les données</li>
<li>Extraire des informations</li>
<li>Prédire des valeurs</li>
<li>Prendre des décisions</li>
</ul>
</section>
<section id="modélisation-1" class="level2">
<h2 class="anchored" data-anchor-id="modélisation-1">Modélisation</h2>
<p>Intervient dans le processus d’analyse de données</p>
<p><img src="figs/data-science-process.png" class="img-fluid"></p>
<p>Le machine learning permet notamment de prédire des valeurs et prendre des décisions.</p>
</section>
<section id="types-de-modèles" class="level2">
<h2 class="anchored" data-anchor-id="types-de-modèles">Types de modèles</h2>
<ul>
<li>Modèles descriptifs</li>
<li>Modèles inférentiels</li>
<li>Modèles prédictifs</li>
</ul>
</section>
<section id="types-de-modèles-1" class="level2">
<h2 class="anchored" data-anchor-id="types-de-modèles-1">Types de modèles</h2>
<p><img src="figs/ml_map.svg" class="img-fluid"></p>
</section>
<section id="types-de-machine-learning" class="level2">
<h2 class="anchored" data-anchor-id="types-de-machine-learning">Types de machine learning</h2>
<ul>
<li><strong>Supervised learning</strong>: On a des données étiquetées
<ul>
<li>Classification</li>
<li>Régression</li>
</ul></li>
<li><strong>Unsupervised learning</strong>: On a des données non étiquetées
<ul>
<li>Clustering</li>
<li>Réduction de dimension</li>
</ul></li>
<li>…</li>
</ul>
</section>
<section id="processus-de-modélisation" class="level2">
<h2 class="anchored" data-anchor-id="processus-de-modélisation">Processus de modélisation</h2>
<ul>
<li><strong>Exploratory data analysis (EDA)</strong>: Comprendre les données, se poser des questions</li>
<li><strong>Feature engineering</strong>: Créer de nouvelles variables à partir des données ou sélectionner les variables les plus pertinentes</li>
<li><strong>Sélection de modèle et tuning</strong>: Choisir le modèle le plus adapté et ajuster les hyperparamètres</li>
<li><strong>Évaluation du modèle</strong>: Mesurer la performance du modèle</li>
</ul>
</section>
<section id="processus-de-modélisation-1" class="level2">
<h2 class="anchored" data-anchor-id="processus-de-modélisation-1">Processus de modélisation</h2>
<p><img src="figs/modeling-process.svg" class="img-fluid" style="background-color: #FFFFFF"></p>
</section>
<section id="modeling-et-tidyverse" class="level2">
<h2 class="anchored" data-anchor-id="modeling-et-tidyverse">Modeling et tidyverse</h2>
<p><span class="heavy-red">Tidymodel</span> est un ensemble de packages qui permettent de faire du machine learning avec le tidyverse.</p>
<p>On retrouve les packages:</p>
<ul>
<li><code>parsnip</code>: Interface pour les modèles</li>
<li><code>dials</code>: Sélection d’hyperparamètres</li>
<li><code>tune</code>: Tuning des hyperparamètres</li>
<li><code>workflow</code>: Workflows pour les modèles</li>
<li><code>yardstick</code>: Métriques de performance</li>
<li><code>recipes</code>: Préparation des données</li>
</ul>
</section>
</section>
<section id="modélisation---étapes-générales" class="level1">
<h1>Modélisation - Étapes générales</h1>
<section id="étapes-générales" class="level2">
<h2 class="anchored" data-anchor-id="étapes-générales">Étapes générales</h2>
<ol start="0" type="1">
<li><strong>Préparation des données</strong>: Nettoyage, transformation, normalisation</li>
<li><strong>Séparation des données</strong>: Entraînement et test</li>
<li><strong>Feature engineering</strong>: Création de nouvelles variables ou sélection des variables les plus pertinentes</li>
<li><strong>Choix du modèle</strong>: Sélection du modèle le plus adapté</li>
<li><strong>Entraînement du modèle</strong>: Apprentissage du modèle sur les données d’entraînement</li>
<li><strong>Évaluation du modèle</strong>: Mesure de la performance du modèle sur les données de test</li>
</ol>
</section>
<section id="les-données" class="level2">
<h2 class="anchored" data-anchor-id="les-données">Les données</h2>
<p>Pour les slides suivantes, nous allons utiliser le jeu de données <code>cells</code> du package <code>modeldata</code>, publiées par <a href="http://www.biomedcentral.com/1471-2105/8/340">Hill, LaPan, Li, and Haney (2007)</a>.</p>
<p>Le jeu de données concerne des images de cellules cancéreuses et indique si elles sont bien segmentées (<code>WS</code>) ou non (<code>PS</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(cells)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2,019
Columns: 58
$ case                         &lt;fct&gt; Test, Train, Train, Train, Test, Test, Te…
$ class                        &lt;fct&gt; PS, PS, WS, PS, PS, WS, WS, PS, WS, WS, W…
$ angle_ch_1                   &lt;dbl&gt; 143.247705, 133.752037, 106.646387, 69.15…
$ area_ch_1                    &lt;int&gt; 185, 819, 431, 298, 285, 172, 177, 251, 4…
$ avg_inten_ch_1               &lt;dbl&gt; 15.71186, 31.92327, 28.03883, 19.45614, 2…
$ avg_inten_ch_2               &lt;dbl&gt; 4.954802, 206.878517, 116.315534, 102.294…
$ avg_inten_ch_3               &lt;dbl&gt; 9.548023, 69.916880, 63.941748, 28.217544…
$ avg_inten_ch_4               &lt;dbl&gt; 2.214689, 164.153453, 106.696602, 31.0280…
$ convex_hull_area_ratio_ch_1  &lt;dbl&gt; 1.124509, 1.263158, 1.053310, 1.202625, 1…
$ convex_hull_perim_ratio_ch_1 &lt;dbl&gt; 0.9196827, 0.7970801, 0.9354750, 0.865829…
$ diff_inten_density_ch_1      &lt;dbl&gt; 29.51923, 31.87500, 32.48771, 26.73228, 3…
$ diff_inten_density_ch_3      &lt;dbl&gt; 13.77564, 43.12228, 35.98577, 22.91732, 2…
$ diff_inten_density_ch_4      &lt;dbl&gt; 6.826923, 79.308424, 51.357050, 26.393701…
$ entropy_inten_ch_1           &lt;dbl&gt; 4.969781, 6.087592, 5.883557, 5.420065, 5…
$ entropy_inten_ch_3           &lt;dbl&gt; 4.371017, 6.642761, 6.683000, 5.436732, 5…
$ entropy_inten_ch_4           &lt;dbl&gt; 2.718884, 7.880155, 7.144601, 5.778329, 5…
$ eq_circ_diam_ch_1            &lt;dbl&gt; 15.36954, 32.30558, 23.44892, 19.50279, 1…
$ eq_ellipse_lwr_ch_1          &lt;dbl&gt; 3.060676, 1.558394, 1.375386, 3.391220, 2…
$ eq_ellipse_oblate_vol_ch_1   &lt;dbl&gt; 336.9691, 2232.9055, 802.1945, 724.7143, …
$ eq_ellipse_prolate_vol_ch_1  &lt;dbl&gt; 110.0963, 1432.8246, 583.2504, 213.7031, …
$ eq_sphere_area_ch_1          &lt;dbl&gt; 742.1156, 3278.7256, 1727.4104, 1194.9320…
$ eq_sphere_vol_ch_1           &lt;dbl&gt; 1900.996, 17653.525, 6750.985, 3884.084, …
$ fiber_align_2_ch_3           &lt;dbl&gt; 1.000000, 1.487935, 1.300522, 1.220424, 1…
$ fiber_align_2_ch_4           &lt;dbl&gt; 1.000000, 1.352374, 1.522316, 1.733250, 1…
$ fiber_length_ch_1            &lt;dbl&gt; 26.98132, 64.28230, 21.14115, 43.14112, 3…
$ fiber_width_ch_1             &lt;dbl&gt; 7.410365, 13.167079, 21.141150, 7.404412,…
$ inten_cooc_asm_ch_3          &lt;dbl&gt; 0.011183899, 0.028051061, 0.006862315, 0.…
$ inten_cooc_asm_ch_4          &lt;dbl&gt; 0.050448005, 0.012594975, 0.006141691, 0.…
$ inten_cooc_contrast_ch_3     &lt;dbl&gt; 40.751777, 8.227953, 14.446074, 7.299457,…
$ inten_cooc_contrast_ch_4     &lt;dbl&gt; 13.895439, 6.984046, 16.700843, 13.390884…
$ inten_cooc_entropy_ch_3      &lt;dbl&gt; 7.199458, 6.822138, 7.580100, 6.312641, 6…
$ inten_cooc_entropy_ch_4      &lt;dbl&gt; 5.249744, 7.098988, 7.671478, 7.197026, 5…
$ inten_cooc_max_ch_3          &lt;dbl&gt; 0.07741935, 0.15321477, 0.02835052, 0.162…
$ inten_cooc_max_ch_4          &lt;dbl&gt; 0.17197452, 0.07387141, 0.02319588, 0.077…
$ kurt_inten_ch_1              &lt;dbl&gt; -0.656744087, -0.248769067, -0.293484630,…
$ kurt_inten_ch_3              &lt;dbl&gt; -0.608058268, -0.330783900, 1.051281336, …
$ kurt_inten_ch_4              &lt;dbl&gt; 0.7258145, -0.2652638, 0.1506140, -0.3472…
$ length_ch_1                  &lt;dbl&gt; 26.20779, 47.21855, 28.14303, 37.85957, 3…
$ neighbor_avg_dist_ch_1       &lt;dbl&gt; 370.4543, 174.4442, 158.4774, 206.3344, 2…
$ neighbor_min_dist_ch_1       &lt;dbl&gt; 99.10349, 30.11114, 34.94477, 33.08030, 2…
$ neighbor_var_dist_ch_1       &lt;dbl&gt; 127.96080, 81.38063, 90.43768, 116.89276,…
$ perim_ch_1                   &lt;dbl&gt; 68.78338, 154.89876, 84.56460, 101.09107,…
$ shape_bfr_ch_1               &lt;dbl&gt; 0.6651480, 0.5397584, 0.7243116, 0.589162…
$ shape_lwr_ch_1               &lt;dbl&gt; 2.462450, 1.468181, 1.328408, 2.826854, 2…
$ shape_p_2_a_ch_1             &lt;dbl&gt; 1.883006, 2.255810, 1.272193, 2.545840, 2…
$ skew_inten_ch_1              &lt;dbl&gt; 0.45450484, 0.39870467, 0.47248709, 0.881…
$ skew_inten_ch_3              &lt;dbl&gt; 0.46039340, 0.61973079, 0.97137879, 0.999…
$ skew_inten_ch_4              &lt;dbl&gt; 1.2327736, 0.5272631, 0.3247065, 0.604439…
$ spot_fiber_count_ch_3        &lt;int&gt; 1, 4, 2, 4, 1, 1, 0, 2, 1, 1, 1, 0, 0, 2,…
$ spot_fiber_count_ch_4        &lt;dbl&gt; 5, 12, 7, 8, 8, 5, 5, 8, 12, 8, 5, 6, 7, …
$ total_inten_ch_1             &lt;int&gt; 2781, 24964, 11552, 5545, 6603, 53779, 43…
$ total_inten_ch_2             &lt;dbl&gt; 701, 160998, 47511, 28870, 30306, 107681,…
$ total_inten_ch_3             &lt;int&gt; 1690, 54675, 26344, 8042, 5569, 21234, 20…
$ total_inten_ch_4             &lt;int&gt; 392, 128368, 43959, 8843, 11037, 57231, 4…
$ var_inten_ch_1               &lt;dbl&gt; 12.47468, 18.80923, 17.29564, 13.81897, 1…
$ var_inten_ch_3               &lt;dbl&gt; 7.609035, 56.715352, 37.671053, 30.005643…
$ var_inten_ch_4               &lt;dbl&gt; 2.714100, 118.388139, 49.470524, 24.74953…
$ width_ch_1                   &lt;dbl&gt; 10.64297, 32.16126, 21.18553, 13.39283, 1…</code></pre>
</div>
</div>
</section>
</section>
<section id="séparation-des-données" class="level1">
<h1>Séparation des données</h1>
<section id="séparation-des-données-1" class="level2">
<h2 class="anchored" data-anchor-id="séparation-des-données-1">Séparation des données</h2>
<p>Il est commun de séparer les données en deux partitions:</p>
<ul>
<li><strong>Données d’entraînement</strong>: Pour estimer les paramètres, comparer les modèles, ajuster les hyperparamètres, etc.</li>
<li><strong>Données de test</strong>: Pour évaluer la performance finale du modèle. Cette partie est gardée en réserve jusqu’à la fin du projet.</li>
</ul>
<p>Il existe différentes façons de créer ces partitions des données. L’approche la plus courante est d’utiliser un échantillon aléatoire. Supposons qu’un quart des données soit réservé pour les données de test. L’échantillonnage aléatoire sélectionnerait aléatoirement 25% pour les données de test et utiliserait le reste pour les données d’entraînement. On peut utiliser le package <code>rsample</code> à cet effet.</p>
</section>
<section id="séparation-des-données-2" class="level2">
<h2 class="anchored" data-anchor-id="séparation-des-données-2">Séparation des données</h2>
<p>Une première approche assez simple serait de séparer les données en deux groupes selon une proportion fixée:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cell_preprossed <span class="ot">&lt;-</span> cells <span class="sc">%&gt;%</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>case)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>cell_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(cell_preprossed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="séparation-des-données-3" class="level2">
<h2 class="anchored" data-anchor-id="séparation-des-données-3">Séparation des données</h2>
<p>Par défaut, la proportion de données dans le set d’entrainement est de 75%. Ici, nous avons un petit soucis: nos classes ne sont pas équilibrées.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cells <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n<span class="sc">/</span><span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  class     n  prop
  &lt;fct&gt; &lt;int&gt; &lt;dbl&gt;
1 PS     1300 0.644
2 WS      719 0.356</code></pre>
</div>
</div>
<p>La solution est de préciser que nous voulons une stratification des données.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cell_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(cell_preprossed,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">strata =</span> class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="séparation-des-données-4" class="level2">
<h2 class="anchored" data-anchor-id="séparation-des-données-4">Séparation des données</h2>
<p>Nous pouvons alors séparer nos deux jeux de données.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cell_train <span class="ot">&lt;-</span> <span class="fu">training</span>(cell_split)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>cell_test  <span class="ot">&lt;-</span> <span class="fu">testing</span>(cell_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Les proportions sont maintenant équilibrées.</p>
<div class="columns">
<div class="column">
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>cell_train <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n<span class="sc">/</span><span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  class     n  prop
  &lt;fct&gt; &lt;int&gt; &lt;dbl&gt;
1 PS      975 0.644
2 WS      539 0.356</code></pre>
</div>
</div>
</div><div class="column">
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>cell_test <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(class) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n<span class="sc">/</span><span class="fu">sum</span>(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  class     n  prop
  &lt;fct&gt; &lt;int&gt; &lt;dbl&gt;
1 PS      325 0.644
2 WS      180 0.356</code></pre>
</div>
</div>
</div>
</div>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">Feature engineering</h2>
<p>Dans cet exemple, il n’est pas nécessaire de faire une feature engineering. Nous allons utiliser toutes les variables disponibles.</p>
</section>
</section>
<section id="modélisation-2" class="level1">
<h1>Modélisation</h1>
<section id="choix-du-modèle" class="level2">
<h2 class="anchored" data-anchor-id="choix-du-modèle">Choix du modèle</h2>
<p>Nous allons utiliser un modèle de régression logistique pour prédire si une cellule est bien segmentée ou non.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>logistic_reg <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="entraînement-du-modèle" class="level2">
<h2 class="anchored" data-anchor-id="entraînement-du-modèle">Entraînement du modèle</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>logistic_fit <span class="ot">&lt;-</span> logistic_reg <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(class <span class="sc">~</span> ., <span class="at">data =</span> cell_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="évaluation-du-modèle" class="level2">
<h2 class="anchored" data-anchor-id="évaluation-du-modèle">Évaluation du modèle</h2>
<p>Commençons par voir les performances du modèle sur les données d’entraînement.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>gml_training_pred <span class="ot">&lt;-</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(logistic_fit, cell_train) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(logistic_fit, cell_train, <span class="at">type =</span> <span class="st">"prob"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the true outcome data back in</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(cell_train <span class="sc">%&gt;%</span> </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>gml_training_pred <span class="sc">%&gt;%</span>                <span class="co"># training set predictions</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(<span class="at">truth =</span> class, .pred_PS)  <span class="co"># truth and predicted probabilities</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc binary         0.896</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>gml_training_pred <span class="sc">%&gt;%</span>                <span class="co"># training set predictions</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth =</span> class, .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary         0.822</code></pre>
</div>
</div>
</section>
<section id="prédiction-avec-le-modèle" class="level2">
<h2 class="anchored" data-anchor-id="prédiction-avec-le-modèle">Prédiction avec le modèle</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>gml_test_pred <span class="ot">&lt;-</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(logistic_fit, cell_test) <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(logistic_fit, cell_test, <span class="at">type =</span> <span class="st">"prob"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the true outcome data back in</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(cell_test <span class="sc">%&gt;%</span> </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">select</span>(class))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>gml_test_pred <span class="sc">%&gt;%</span>                <span class="co"># training set predictions</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(<span class="at">truth =</span> class, .pred_PS)  <span class="co"># truth and predicted probabilities</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc binary         0.894</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>gml_test_pred <span class="sc">%&gt;%</span>                <span class="co"># training set predictions</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">accuracy</span>(<span class="at">truth =</span> class, .pred_class)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric  .estimator .estimate
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
1 accuracy binary         0.814</code></pre>
</div>
</div>
</section>
</section>
<section id="rééchantillonnage" class="level1">
<h1>Rééchantillonnage</h1>
<section id="rééchantillonnage-1" class="level2">
<h2 class="anchored" data-anchor-id="rééchantillonnage-1">Rééchantillonnage</h2>
<p>Pour obtenir une meilleure estimation de la performance du modèle, on peut utiliser le rééchantillonnage.</p>
<p><img src="figs/resampling.svg" class="img-fluid" style="background-color: #FDFDE1"></p>
</section>
<section id="rééchantillonnage-2" class="level2">
<h2 class="anchored" data-anchor-id="rééchantillonnage-2">Rééchantillonnage</h2>
<p>Il existe plusieurs méthodes de rééchantillonnage:</p>
<ul>
<li>Validation croisée</li>
<li>Bootstrap</li>
<li>Leave-one-out</li>
<li>…</li>
</ul>
<p>Nous allons utiliser la validation croisée.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(cell_train, <span class="at">v =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="validation-croisée" class="level2">
<h2 class="anchored" data-anchor-id="validation-croisée">Validation croisée</h2>
<p><img src="figs/cv.png" class="img-fluid"></p>
</section>
<section id="rééchantillonnage-3" class="level2">
<h2 class="anchored" data-anchor-id="rééchantillonnage-3">Rééchantillonnage</h2>
<p>Nous pouvons alors entraîner notre modèle sur les différents <em>folds</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>gml_res <span class="ot">&lt;-</span> logistic_reg <span class="sc">%&gt;%</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(class <span class="sc">~</span> ., </span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                <span class="at">resamples =</span> folds)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(gml_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  .metric     .estimator  mean     n std_err .config             
  &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary     0.797    10 0.00904 Preprocessor1_Model1
2 brier_class binary     0.139    10 0.00511 Preprocessor1_Model1
3 roc_auc     binary     0.871    10 0.00875 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>Nous voyons que les performances sont assez similaires à celles obtenues avec les données de test !</p>
</section>
</section>
<section id="optimisation-des-hyperparamètres" class="level1">
<h1>Optimisation des hyperparamètres</h1>
<section id="tune" class="level2">
<h2 class="anchored" data-anchor-id="tune"><code>tune()</code></h2>
<p>Certains modèles possèdent des hyperparamètres qui peuvent être ajustés pour améliorer la performance du modèle.</p>
<p>Nous allons prendre comme exemple le même jeu de données mais cette fois nous allons utiliser un modèle d’arbre de décision.</p>
</section>
<section id="arbre-de-décisions" class="level2">
<h2 class="anchored" data-anchor-id="arbre-de-décisions">Arbre de décisions</h2>
<div class="columns">
<div class="column">
<p><img src="figs/iris-decision-tree-1.png" class="img-fluid"></p>
</div><div class="column">
<p><img src="figs/iris-decision-tree-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="arbre-de-décisions-1" class="level2">
<h2 class="anchored" data-anchor-id="arbre-de-décisions-1">Arbre de décisions</h2>
<p>Il y a deux hyperparamètres principaux pour les arbres de décisions:</p>
<ul>
<li><code>cost_complexity</code>: Ajoute une pénalité pour la complexité de l’arbre et permet d’éviter l’overfitting</li>
<li><code>tree_depth</code>: Profondeur maximale de l’arbre</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>tune_spec <span class="ot">&lt;-</span> </span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">decision_tree</span>(</span>
<span id="cb27-3"><a href="#cb27-3"></a>    <span class="at">cost_complexity =</span> <span class="fu">tune</span>(), <span class="co"># Paramètre à tuner</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>    <span class="at">tree_depth =</span> <span class="fu">tune</span>()       <span class="co"># Paramètre à tuner</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb27-6"><a href="#cb27-6"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-7"><a href="#cb27-7"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb27-8"><a href="#cb27-8"></a></span>
<span id="cb27-9"><a href="#cb27-9"></a>tune_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Decision Tree Model Specification (classification)

Main Arguments:
  cost_complexity = tune()
  tree_depth = tune()

Computational engine: rpart </code></pre>
</div>
</div>
</section>
<section id="recherche-des-hyperparamètres" class="level2">
<h2 class="anchored" data-anchor-id="recherche-des-hyperparamètres">Recherche des hyperparamètres</h2>
<p>Nous allons ensuite lui donner une grille de recherche. Il va tester toutes les combinaisons possibles des hyperparamètres pour trouver la meilleure combinaison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>tree_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(<span class="fu">cost_complexity</span>(),</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">tree_depth</span>(),</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">levels =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="recherche-des-hyperparamètres-1" class="level2">
<h2 class="anchored" data-anchor-id="recherche-des-hyperparamètres-1">Recherche des hyperparamètres</h2>
<p>On commence par séparer nos données en données d’entraînement et de test.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>cell_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(cells <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>case), </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">strata =</span> class)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>cell_train <span class="ot">&lt;-</span> <span class="fu">training</span>(cell_split)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>cell_test  <span class="ot">&lt;-</span> <span class="fu">testing</span>(cell_split)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>cell_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(cell_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="recherche-des-hyperparamètres-2" class="level2">
<h2 class="anchored" data-anchor-id="recherche-des-hyperparamètres-2">Recherche des hyperparamètres</h2>
<p>On peut maintenant lancer la recherche des hyperparamètres.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tune_res <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(tune_spec,</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>                      class <span class="sc">~</span> .,         <span class="co"># On indique la formule</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">resamples =</span> folds,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">grid =</span> tree_grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="analyse-des-résultats" class="level2">
<h2 class="anchored" data-anchor-id="analyse-des-résultats">Analyse des résultats</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>tune_res <span class="sc">%&gt;%</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 75 × 8
   cost_complexity tree_depth .metric     .estimator  mean     n std_err .config
             &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  
 1    0.0000000001          1 accuracy    binary     0.731    10 0.0121  Prepro…
 2    0.0000000001          1 brier_class binary     0.170    10 0.00294 Prepro…
 3    0.0000000001          1 roc_auc     binary     0.764    10 0.00790 Prepro…
 4    0.0000000178          1 accuracy    binary     0.731    10 0.0121  Prepro…
 5    0.0000000178          1 brier_class binary     0.170    10 0.00294 Prepro…
 6    0.0000000178          1 roc_auc     binary     0.764    10 0.00790 Prepro…
 7    0.00000316            1 accuracy    binary     0.731    10 0.0121  Prepro…
 8    0.00000316            1 brier_class binary     0.170    10 0.00294 Prepro…
 9    0.00000316            1 roc_auc     binary     0.764    10 0.00790 Prepro…
10    0.000562              1 accuracy    binary     0.731    10 0.0121  Prepro…
# ℹ 65 more rows</code></pre>
</div>
</div>
</section>
<section id="analyse-des-résultats-1" class="level2">
<h2 class="anchored" data-anchor-id="analyse-des-résultats-1">Analyse des résultats</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>tune_res <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>() <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tree_depth =</span> <span class="fu">factor</span>(tree_depth)) <span class="sc">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(cost_complexity, mean, <span class="at">color =</span> tree_depth)) <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_number</span>()) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>(<span class="at">option =</span> <span class="st">"plasma"</span>, <span class="at">begin =</span> .<span class="dv">9</span>, <span class="at">end =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09---ML_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="choix-des-hyperparamètres" class="level2">
<h2 class="anchored" data-anchor-id="choix-des-hyperparamètres">Choix des hyperparamètres</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>tune_res <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  cost_complexity tree_depth .metric  .estimator  mean     n std_err .config    
            &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;      
1    0.0000000001          4 accuracy binary     0.801    10 0.00792 Preprocess…
2    0.0000000178          4 accuracy binary     0.801    10 0.00792 Preprocess…
3    0.00000316            4 accuracy binary     0.801    10 0.00792 Preprocess…
4    0.000562              4 accuracy binary     0.801    10 0.00792 Preprocess…
5    0.0000000001          8 accuracy binary     0.781    10 0.00853 Preprocess…</code></pre>
</div>
</div>
<p>On peut maintenant entraîner notre modèle avec les hyperparamètres optimisés. Nous allons</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>best_tree <span class="ot">&lt;-</span> tune_res <span class="sc">%&gt;%</span> </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>final_tree <span class="ot">&lt;-</span> <span class="fu">finalize_model</span>(tune_spec, best_tree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="entraînement-du-modèle-1" class="level2">
<h2 class="anchored" data-anchor-id="entraînement-du-modèle-1">Entraînement du modèle</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> <span class="fu">last_fit</span>(final_tree,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                      class <span class="sc">~</span> .,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                      cell_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Performances :</p>
<div class="columns">
<div class="column">
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>final_fit <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric     .estimator .estimate .config             
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary         0.824 Preprocessor1_Model1
2 roc_auc     binary         0.848 Preprocessor1_Model1
3 brier_class binary         0.141 Preprocessor1_Model1</code></pre>
</div>
</div>
</div><div class="column">
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>final_fit <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(class, .pred_PS) <span class="sc">%&gt;%</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="09---ML_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="recettes-et-workflows" class="level1">
<h1>Recettes et workflows</h1>
<section id="feitures-engineering-avec-recipes" class="level2">
<h2 class="anchored" data-anchor-id="feitures-engineering-avec-recipes">Feitures engineering avec <code>recipes</code></h2>
<p><code>tidymodels</code> et son package <code>recipes</code> permettent de créer des recettes pour préparer les données. Cela permet de transformer certaines variables, de créer de nouvelles variables, etc.</p>
<p>Nous allons prendre ici comme exemple le jeu de données <code>nyflights13</code>.</p>
</section>
<section id="data-prerocessing" class="level2">
<h2 class="anchored" data-anchor-id="data-prerocessing">Data prerocessing</h2>
<p>Commencons par préparer et nettroyer nos données:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nycflights13)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>flight_data <span class="ot">&lt;-</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  flights <span class="sc">%&gt;%</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># On change le retard en facteur</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">arr_delay =</span> <span class="fu">ifelse</span>(arr_delay <span class="sc">&gt;=</span> <span class="dv">30</span>, <span class="st">"late"</span>, <span class="st">"on_time"</span>),</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">arr_delay =</span> <span class="fu">factor</span>(arr_delay),</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Nous aurons besoin de la date</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(time_hour)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># On ajoute les données de météo</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(weather, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"origin"</span>, <span class="st">"time_hour"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># On ne garde que les colonnes utiles</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(dep_time, flight, origin, dest, air_time, distance, </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>         carrier, date, arr_delay, time_hour) <span class="sc">%&gt;%</span> </span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># On enlève les lignes avec des données manquantes</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Pour faire des modèles, on préfère avoir des facteurs que du texte</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.character, as.factor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Nous allons chercher à prédire le retard en fonction de différentes variables</p>
</section>
<section id="data-preprocessing" class="level2">
<h2 class="anchored" data-anchor-id="data-preprocessing">Data preprocessing</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(flight_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 325,819
Columns: 10
$ dep_time  &lt;int&gt; 517, 533, 542, 544, 554, 554, 555, 557, 557, 558, 558, 558, …
$ flight    &lt;int&gt; 1545, 1714, 1141, 725, 461, 1696, 507, 5708, 79, 301, 49, 71…
$ origin    &lt;fct&gt; EWR, LGA, JFK, JFK, LGA, EWR, EWR, LGA, JFK, LGA, JFK, JFK, …
$ dest      &lt;fct&gt; IAH, IAH, MIA, BQN, ATL, ORD, FLL, IAD, MCO, ORD, PBI, TPA, …
$ air_time  &lt;dbl&gt; 227, 227, 160, 183, 116, 150, 158, 53, 140, 138, 149, 158, 3…
$ distance  &lt;dbl&gt; 1400, 1416, 1089, 1576, 762, 719, 1065, 229, 944, 733, 1028,…
$ carrier   &lt;fct&gt; UA, UA, AA, B6, DL, UA, B6, EV, B6, AA, B6, B6, UA, UA, AA, …
$ date      &lt;date&gt; 2013-01-01, 2013-01-01, 2013-01-01, 2013-01-01, 2013-01-01,…
$ arr_delay &lt;fct&gt; on_time, on_time, late, on_time, on_time, on_time, on_time, …
$ time_hour &lt;dttm&gt; 2013-01-01 05:00:00, 2013-01-01 05:00:00, 2013-01-01 05:00:…</code></pre>
</div>
</div>
</section>
<section id="séparation-des-données-5" class="level2">
<h2 class="anchored" data-anchor-id="séparation-des-données-5">Séparation des données</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(flight_data, <span class="at">prop =</span> <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="recettes" class="level2">
<h2 class="anchored" data-anchor-id="recettes">Recettes</h2>
<p>Une recette de base prend une <strong>formule</strong> et des <strong>données</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Par défaut, toutes les variables sont des <code>predictors</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(flights_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
   variable  type      role      source  
   &lt;chr&gt;     &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
 1 dep_time  &lt;chr [2]&gt; predictor original
 2 flight    &lt;chr [2]&gt; predictor original
 3 origin    &lt;chr [3]&gt; predictor original
 4 dest      &lt;chr [3]&gt; predictor original
 5 air_time  &lt;chr [2]&gt; predictor original
 6 distance  &lt;chr [2]&gt; predictor original
 7 carrier   &lt;chr [3]&gt; predictor original
 8 date      &lt;chr [1]&gt; predictor original
 9 time_hour &lt;chr [1]&gt; predictor original
10 arr_delay &lt;chr [3]&gt; outcome   original</code></pre>
</div>
</div>
</section>
<section id="recettes-1" class="level2">
<h2 class="anchored" data-anchor-id="recettes-1">Recettes</h2>
<p>Nous pouvons maintenant appliquer des transformations sur les colonnes pour créer des variables adaptées à notre modèle.</p>
<p>Il existe de nombreuses recettes dans le package <code>recipes</code>. Elles ont toute la forme <code>step_X()</code> où <code>X</code> sera le nom d’une recette.</p>
<p>Par exemple, la recette <code>step_date</code> permet de transformer une date en une autre variable (jour de la semaine, mois, années, …)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(date, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">"dow"</span>, <span class="st">"month"</span>))</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">prep</span>(flights_rec) <span class="sc">%&gt;%</span> <span class="fu">juice</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"date"</span>)) <span class="co"># Pour voir le résultat</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 244,364 × 3
   date       date_dow date_month
   &lt;date&gt;     &lt;fct&gt;    &lt;fct&gt;     
 1 2013-05-03 Fri      May       
 2 2013-03-04 Mon      Mar       
 3 2013-02-20 Wed      Feb       
 4 2013-04-02 Tue      Apr       
 5 2013-06-13 Thu      Jun       
 6 2013-02-21 Thu      Feb       
 7 2013-05-08 Wed      May       
 8 2013-10-21 Mon      Oct       
 9 2013-11-12 Tue      Nov       
10 2013-09-11 Wed      Sep       
# ℹ 244,354 more rows</code></pre>
</div>
</div>
</section>
<section id="recettes-2" class="level2">
<h2 class="anchored" data-anchor-id="recettes-2">Recettes</h2>
<p>Nous allons transformer les variables de différentes manières:</p>
<ul>
<li><code>update_role</code>: Pour indiquer les variables que l’on veut garder comme identifiant (<code>ID</code>)</li>
<li><code>step_date</code>: Pour transformer la date en variables plus utiles</li>
<li><code>step_holiday</code>: Pour indiquer si une date tombe un jour férié</li>
<li><code>step_dummy</code>: Pour transformer les variables catégorielles en variables binaires</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>flights_rec <span class="ot">&lt;-</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(arr_delay <span class="sc">~</span> ., <span class="at">data =</span> train_data) <span class="sc">%&gt;%</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(flight, time_hour, <span class="at">new_role =</span> <span class="st">"ID"</span>) <span class="sc">%&gt;%</span>   </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(date, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">"dow"</span>, <span class="st">"month"</span>)) <span class="sc">%&gt;%</span>               </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(date, </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">holidays =</span> timeDate<span class="sc">::</span><span class="fu">listHolidays</span>(<span class="st">"US"</span>), </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">keep_original_cols =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="faire-un-workflow" class="level2">
<h2 class="anchored" data-anchor-id="faire-un-workflow">Faire un <code>workflow</code></h2>
<p>Un <code>workflow</code> est une combinaison d’une recette et d’un modèle. Il permet d’enchainer différentes opérations.</p>
<p>Commençons par définir un modèle:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>lr_mod <span class="ot">&lt;-</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="workflow" class="level2">
<h2 class="anchored" data-anchor-id="workflow"><code>workflow</code></h2>
<p>Nous pouvons maintenant combiner notre recette et notre modèle pour créer un <code>workflow</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>flights_wf <span class="ot">&lt;-</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(flights_rec) <span class="sc">%&gt;%</span> </span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(lr_mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="entrainer-un-workflow" class="level2">
<h2 class="anchored" data-anchor-id="entrainer-un-workflow">Entrainer un <code>workflow</code></h2>
<p>Nous pouvons ensuite entraîner notre modèle. Pour cela, nous pouvons directement utiliser la fonction <code>fit</code> du <code>workflow</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>flights_fit <span class="ot">&lt;-</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  flights_wf <span class="sc">%&gt;%</span> </span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="rééchantillonnage-avec-un-workflow" class="level2">
<h2 class="anchored" data-anchor-id="rééchantillonnage-avec-un-workflow">Rééchantillonnage avec un <code>workflow</code></h2>
<p>Nous pouvons également fiter notre modèle avec une validation croisée.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>flights_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(train_data, <span class="at">v=</span><span class="dv">10</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>flights_res <span class="ot">&lt;-</span> </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  flights_wf <span class="sc">%&gt;%</span> </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(<span class="at">resamples =</span> flights_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="évaluation-du-modèle-1" class="level2">
<h2 class="anchored" data-anchor-id="évaluation-du-modèle-1">Évaluation du modèle</h2>
<p>Comme précédemment, nous pouvons directement accéder aux résultats du modèle</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>flights_res <span class="sc">%&gt;%</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  .metric     .estimator  mean     n  std_err .config             
  &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;               
1 accuracy    binary     0.849    10 0.000521 Preprocessor1_Model1
2 brier_class binary     0.114    10 0.000359 Preprocessor1_Model1
3 roc_auc     binary     0.766    10 0.00111  Preprocessor1_Model1</code></pre>
</div>
</div>
</section>
<section id="hyperparamètres-et-workflow" class="level2">
<h2 class="anchored" data-anchor-id="hyperparamètres-et-workflow">Hyperparamètres et <code>workflow</code></h2>
<p>Nous pouvons également utiliser les fonctions pour optimiser les hyperparamètres directement avec un workflow.</p>
<p>Précédemment, nous avions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>tune_res <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(tune_spec,</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>                      class <span class="sc">~</span> .,         <span class="co"># On indique la formule</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">resamples =</span> folds,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">grid =</span> tree_grid)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>best_tree <span class="ot">&lt;-</span> tune_res <span class="sc">%&gt;%</span> </span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>final_tree <span class="ot">&lt;-</span> <span class="fu">finalize_model</span>(tune_spec, best_tree)</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> <span class="fu">last_fit</span>(final_tree,</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>                      class <span class="sc">~</span> .,</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>                      cell_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hyperparamètres-et-workflow-1" class="level2">
<h2 class="anchored" data-anchor-id="hyperparamètres-et-workflow-1">Hyperparamètres et <code>workflow</code></h2>
<p>Avec un <code>workflow</code>, cela devient:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>tree_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tune_spec) <span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(class <span class="sc">~</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>best_tree <span class="ot">&lt;-</span> </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  tree_wf <span class="sc">%&gt;%</span> </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> cell_folds,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">grid =</span> tree_grid</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="at">metric =</span> <span class="st">"accuracy"</span>)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>final_wf <span class="ot">&lt;-</span> </span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>  tree_wf <span class="sc">%&gt;%</span> </span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_tree)</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>final_fit <span class="ot">&lt;-</span> </span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  final_wf <span class="sc">%&gt;%</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(cell_split) </span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>final_fit <span class="sc">%&gt;%</span></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="références" class="level2">
<h2 class="anchored" data-anchor-id="références">Références</h2>
<div id="refs" role="list">

</div>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>